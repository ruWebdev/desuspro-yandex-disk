# Система автоматической очистки локальных копий изображений

## Обзор

Система управляет локальными уменьшенными копиями (thumbnails) изображений, загруженных в задачи. При установке статуса задачи "ПРИНЯТА" (`accepted`) или "ОТМЕНЕНА" (`cancelled`), локальные копии **не удаляются немедленно**, а помечаются для отложенного удаления через 14 дней.

## Архитектура

### База данных

**Таблица:** `task_file_thumbnails`

Поля:
- `id` - первичный ключ
- `task_id` - ID задачи (внешний ключ на `tasks.id`)
- `name` - оригинальное имя файла
- `thumbnail_path` - путь к файлу в storage
- `accepted_at` - timestamp когда задача была принята (NULL если не принята)
- `created_at`, `updated_at` - стандартные timestamps

**Индексы:**
- `task_id, name` - для быстрого поиска по задаче и имени файла
- `accepted_at` - для эффективной очистки старых записей

### Файловая система

Thumbnails хранятся в: `storage/app/public/tasks/{task_id}/thumbnails/`

## Жизненный цикл thumbnails

### 1. Создание
- При загрузке файла на Яндекс.Диск через `TaskOffcanvas.vue`
- Вызывается `TaskFileController::thumbnail()` для создания уменьшенной копии
- Файл сохраняется в storage, запись создаётся в БД с `accepted_at = NULL`

### 2. Использование
- `TaskOffcanvas.vue` загружает список thumbnails через `loadLocalThumbnails()`
- `LightboxModal.vue` отображает thumbnails в галерее
- Thumbnails используются для быстрого просмотра без обращения к Яндекс.Диску

### 3. Пометка для удаления
**Триггер:** Изменение статуса задачи на `accepted` или `cancelled`

**Процесс:**
1. `TaskController::update()` или `TaskController::bulkUpdate()` обнаруживает изменение статуса
2. Вызывается `TaskController::cleanupTaskThumbnails($task)`
3. Все thumbnails задачи помечаются: `accepted_at = now()`
4. Логируется информация о пометке и дате будущего удаления

**Важно:** Файлы НЕ удаляются на этом этапе!

### 4. Автоматическая очистка
**Команда:** `php artisan thumbnails:cleanup`

**Расписание:** Ежедневно в 03:00 (настроено в `routes/console.php`)

**Процесс:**
1. Находит все thumbnails где `accepted_at <= now() - 14 days`
2. Группирует по `task_id`
3. Если ВСЕ thumbnails задачи помечены для удаления - удаляет всю директорию
4. Если только часть - удаляет отдельные файлы
5. Удаляет записи из БД
6. Логирует результаты

## Использование команды

### Автоматический запуск
Команда запускается автоматически через Laravel Scheduler. Убедитесь, что настроен cron:

```bash
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

### Ручной запуск

**Стандартная очистка (14 дней):**
```bash
php artisan thumbnails:cleanup
```

**Изменить период хранения:**
```bash
php artisan thumbnails:cleanup --days=30
```

**Тестовый режим (без удаления):**
```bash
php artisan thumbnails:cleanup --dry-run
```

Покажет список файлов, которые будут удалены, без фактического удаления.

## Особые случаи

### Явное удаление файла
При удалении файла через кнопку "УДАЛИТЬ" в интерфейсе:
- Файл удаляется с Яндекс.Диска
- Локальный thumbnail удаляется **немедленно**
- Запись удаляется из БД
- Это корректное поведение - пользователь явно удалил файл

### Удаление задачи
При удалении задачи (каскадное удаление через FK):
- Model hook `Task::deleting()` удаляет все файлы thumbnails
- FK cascade удаляет записи из БД
- Это происходит независимо от `accepted_at`

### Восстановление задачи из статуса "accepted"
Если статус задачи изменён обратно с "accepted" на другой:
- Thumbnails остаются помеченными (`accepted_at` не сбрасывается)
- Они всё равно будут удалены через 14 дней
- Это намеренное поведение для предотвращения накопления старых файлов

## Мониторинг и логирование

### События логируются в Laravel log:

**При пометке для удаления:**
```
[info] Marked thumbnails for delayed cleanup
  task_id: 123
  cleanup_after: 2025-10-16 11:55:00
```

**При успешной очистке:**
```
[info] Thumbnail cleanup completed successfully
  deleted_files: 15
  deleted_records: 15
```

**При ошибках:**
```
[error] Failed to mark thumbnails for cleanup
  task_id: 123
  error: ...
```

## Миграция существующих данных

После развёртывания изменений:

1. **Запустить миграцию:**
```bash
php artisan migrate
```

2. **Пометить существующие thumbnails принятых задач:**
```sql
UPDATE task_file_thumbnails t
INNER JOIN tasks tk ON t.task_id = tk.id
SET t.accepted_at = tk.updated_at
WHERE tk.status IN ('accepted', 'cancelled')
  AND t.accepted_at IS NULL;
```

3. **Проверить в тестовом режиме:**
```bash
php artisan thumbnails:cleanup --dry-run
```

## Производительность

- Индекс на `accepted_at` обеспечивает быстрый поиск старых записей
- Группировка по `task_id` минимизирует операции с файловой системой
- Удаление целых директорий эффективнее удаления отдельных файлов
- Команда безопасна для запуска на продакшене

## Безопасность

- ✅ Существующий функционал не изменён
- ✅ Thumbnails доступны в течение 14 дней после принятия задачи
- ✅ Явное удаление файлов работает как прежде
- ✅ Ошибки логируются, но не прерывают процесс
- ✅ Dry-run режим для тестирования

## Настройка

Для изменения периода хранения по умолчанию, отредактируйте `routes/console.php`:

```php
// Изменить с 14 на 30 дней
Schedule::command('thumbnails:cleanup --days=30')->dailyAt('03:00');
```

Для изменения времени запуска:

```php
// Запускать в 02:00 вместо 03:00
Schedule::command('thumbnails:cleanup')->dailyAt('02:00');
```
